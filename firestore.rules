/**
 * @file Firebase Security Rules for BoardPrep Pro.
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for user-specific data
 * and allows public read access to questions and quizzes. Write access is restricted to
 * authenticated users where appropriate, with owner validation.  No data shape validation occurs.
 *
 * @data_structure
 * - /users/{userId}: Stores user profiles.
 * - /users/{userId}/pointHistory/{pointEntryId}: Stores point history for each user.
 * - /questions/{questionId}: Stores questions (public read).
 * - /quizzes/{quizId}: Stores quizzes (public read).
 * - /users/{userId}/quizAttempts/{quizAttemptId}: Stores quiz attempts for each user.
 * - /users/{userId}/attemptedQuestions/{attemptedQuestionId}: Stores attempted questions for each user.
 *
 * @key_security_decisions
 * - User listing is disallowed.
 * - Public read access is granted for questions and quizzes.
 * - Owner-only write access is enforced for user-specific data.
 *
 * @denormalization_for_authorization None required as path-based authorization is used.
 * @structural_segregation User-specific private data is stored in user subcollections, while
 * public data (questions, quizzes) is stored in top-level collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Defines the `isSignedIn()` helper function.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Authentication is required for nearly all operations
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Defines the `isOwner(userId)` helper function.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Checks if the request is made by the owner of the document.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Defines the `isExistingOwner(userId)` helper function.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Checks if the request is made by the owner of an existing document.
     */
    function isExistingOwner(userId) {
      return isSignedIn() && resource.data.id == request.auth.uid;
    }

    /**
     * @description Grants access to user profiles.
     * @path /users/{userId}
     * @allow (create) User creates their own profile (auth.uid matches userId).
     * @deny (create) User tries to create a profile for another user (auth.uid does not match userId).
     * @allow (get) User reads their own profile.
     * @deny (get) User tries to read another user's profile.
     * @principle Enforces document ownership for writes and reads.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Grants access to user point history entries.
     * @path /users/{userId}/pointHistory/{pointEntryId}
     * @allow (create) User creates a point history entry for themselves (auth.uid matches userId).
     * @deny (create) User tries to create a point history entry for another user (auth.uid does not match userId).
     * @allow (get) User reads their own point history entry.
     * @allow (list) User lists their own point history entries.
     * @deny (get) User tries to read another user's point history entry.
     * @principle Enforces document ownership for writes and reads within the user's data tree.
     */
    match /users/{userId}/pointHistory/{pointEntryId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Grants public read access to questions.
     * @path /questions/{questionId}
     * @allow (get, list) Any user can read questions.
     * @deny (create, update, delete) No user can create, update, or delete questions.
     * @principle Allows public read access while restricting write access.
     */
    match /questions/{questionId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Grants public read access to quizzes.
     * @path /quizzes/{quizId}
     * @allow (get, list) Any user can read quizzes.
     * @deny (create, update, delete) No user can create, update, or delete quizzes.
     * @principle Allows public read access while restricting write access.
     */
    match /quizzes/{quizId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Grants access to user quiz attempts.
     * @path /users/{userId}/quizAttempts/{quizAttemptId}
     * @allow (create) User creates a quiz attempt for themselves (auth.uid matches userId).
     * @deny (create) User tries to create a quiz attempt for another user (auth.uid does not match userId).
     * @allow (get) User reads their own quiz attempt.
     * @allow (list) User lists their own quiz attempts.
     * @deny (get) User tries to read another user's quiz attempt.
     * @principle Enforces document ownership for writes and reads within the user's data tree.
     */
    match /users/{userId}/quizAttempts/{quizAttemptId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Grants access to user attempted questions.
     * @path /users/{userId}/attemptedQuestions/{attemptedQuestionId}
     * @allow (create) User creates an attempted question record for themselves (auth.uid matches userId).
     * @deny (create) User tries to create an attempted question record for another user (auth.uid does not match userId).
     * @allow (get) User reads their own attempted question record.
     * @allow (list) User lists their own attempted question records.
     * @deny (get) User tries to read another user's attempted question record.
     * @principle Enforces document ownership for writes and reads within the user's data tree.
     */
    match /users/{userId}/attemptedQuestions/{attemptedQuestionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }
  }
}